<?xml version="1.0" encoding="UTF-8"?>
<!--
This software is in the public domain under CC0 1.0 Universal plus a
Grant of Patent License.

To the extent possible under law, the author(s) have dedicated all
copyright and related and neighboring rights to this software to the
public domain worldwide. This software is distributed without any
warranty.

You should have received a copy of the CC0 Public Domain Dedication
along with this software (see the LICENSE.md file). If not, see
<http://creativecommons.org/publicdomain/zero/1.0/>.
-->
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd" default-menu-title="Evaluate Product" default-menu-index="20" menu-image="fa fa-file" menu-image-type="icon" default-menu-include="false">

    <parameter name="productEvaluationId" required="true"/>

    <always-actions>
        <if condition="!activeOrgId">
            <message>${ec.resource.expand('CoarchySelectAnOrg', null)}</message>
            <script>sri.sendRedirectAndStopRender('/settings/Organizations')</script>
        </if>
        <entity-find-count entity-name="mantle.party.PartyRelationship" count-field="partyRelationshipCount">
            <date-filter/>
            <econdition field-name="relationshipTypeEnumId" value="PrtMember"/>
            <econdition field-name="toRoleTypeId" value="OrgInternal"/>
            <econdition field-name="fromPartyId" from="ec.user.userAccount.partyId"/>
            <econdition field-name="toPartyId" from="activeOrgId"/>
        </entity-find-count>
        <entity-find-count entity-name="mantle.party.PartyActivation" count-field="partyActivationCount">
            <date-filter/>
            <econdition field-name="partyId" from="activeOrgId"/>
        </entity-find-count>
    </always-actions>

    <transition name="inviteVendor">
        <condition>
            <expression>partyRelationshipCount &gt; 0 &amp;&amp; partyActivationCount &gt; 0</expression>
        </condition>
        <service-call name="coarchy.ProductEvaluationServices.add#ProductEvaluationParty" in-map="[productEvaluationId:productEvaluationId,emailAddress:emailAddress,firstName:firstName,lastName:lastName,organizationId:activeOrgId]"/>
        <default-response url="." type="screen-last" />
    </transition>

    <transition name="finalizeActivitySelection">
        <condition>
            <expression>partyRelationshipCount &gt; 0 &amp;&amp; partyActivationCount &gt; 0</expression>
        </condition>
        <service-call name="coarchy.ProductEvaluationServices.finalize#ProductEvaluationActivitySelection" in-map="[productEvaluationId:productEvaluationId]"/>
        <default-response url="." type="screen-last"/>
    </transition>

    <transition name="finalizeVendorInvitations">
        <condition>
            <expression>partyRelationshipCount &gt; 0 &amp;&amp; partyActivationCount &gt; 0</expression>
        </condition>
        <service-call name="coarchy.ProductEvaluationServices.finalize#ProductEvaluationVendorInvitations" in-map="[productEvaluationId:productEvaluationId]"/>
        <default-response url="." type="screen-last"/>
    </transition>

    <transition name="reopenActivitySelection">
        <condition>
            <expression>partyRelationshipCount &gt; 0 &amp;&amp; partyActivationCount &gt; 0</expression>
        </condition>
        <service-call name="coarchy.ProductEvaluationServices.reopen#ProductEvaluationActivitySelection" in-map="[productEvaluationId:productEvaluationId]"/>
        <default-response url="." type="screen-last"/>
    </transition>

    <transition name="cancelProductEvaluation">
        <condition>
            <expression>partyRelationshipCount &gt; 0 &amp;&amp; partyActivationCount &gt; 0</expression>
        </condition>
        <service-call name="coarchy.ProductEvaluationServices.cancel#ProductEvaluation" in-map="[productEvaluationId:productEvaluationId]"/>
        <default-response url="." type="screen-last"/>
    </transition>

    <transition name="completeProductEvaluation">
        <condition>
            <expression>partyRelationshipCount &gt; 0 &amp;&amp; partyActivationCount &gt; 0</expression>
        </condition>
        <service-call name="coarchy.ProductEvaluationServices.complete#ProductEvaluation" in-map="[productEvaluationId:productEvaluationId]"/>
        <default-response url="." type="screen-last"/>
    </transition>

    <transition-include name="upgradeParty" location="component://coarchy/screen/coarchy/cointernal/Home.xml"/>

    <subscreens default-item="EvalStatements">
        <subscreens-item name="EvalStatements" menu-include="true" menu-index="10" location="component://coarchy/screen/coarchy/cointernal/Products/EditProductEval/EvalStatements.xml"/>
        <subscreens-item name="EvalProcessStories" menu-include="true" menu-index="20" location="component://coarchy/screen/coarchy/cointernal/Products/EditProductEval/EvalProcessStories.xml"/>
    </subscreens>

    <actions>
        <!-- find product eval -->
        <entity-find-one entity-name="coarchy.product.ProductEvaluationAndProduct" value-field="productEvaluation"/>
        <set field="statusId" from="productEvaluation?.statusId"/>

        <!-- safegaurd vendors from accessing product evaluation before its ready for them -->
        <if condition="isVendorView &amp;&amp; ['PeRequirementsSelection','PeInviteVendors'].contains(statusId)">
            <return error="true" message="Not allowed"/>
        </if>

        <!-- find invited vendors -->
        <entity-find entity-name="coarchy.product.ProductEvaluationParty" list="vendorRepList">
            <date-filter />
            <econdition field-name="productEvaluationId" />
            <econdition field-name="roleTypeId" value="VendorRepresentative" />
        </entity-find>

        <!-- note: isVendorView=true is set in always-actions in vendor app to determine where this is being accessed from -->
        <set field="isUserInternalOrgMember" from="partyRelationshipCount &gt; 0"/>
        <set field="isUserVendor" from="(vendorRepList*.partyId).contains(ec.user.userAccount?.partyId)"/>
        
        <!-- canInviteVendors controls the invite party dialog -->
        <set field="canInviteVendors" from="['PeRequirementsSelection','PeInviteVendors','PeAwaitingVendorResponse'].contains(statusId)"/>
        <!-- showInviteVendorsSection controls the whole vendor rep list section) -->
        <set field="showInviteVendorsSection" from="['PeInviteVendors','PeAwaitingVendorResponse','PeCompleted','PeCancelled'].contains(statusId)"/>

        <!-- check if all statements and stories have been responded to -->
        <service-call name="coarchy.ProductEvaluationServices.get#ProductEvaluationCompleteWarnings" in-map="[productEvaluationId:productEvaluationId]" out-map="context" />
    </actions>

    <widgets>
        <section name="FreemiumBanner" condition="partyActivationCount == 0">
            <widgets>
                <container type="q-banner inline-actions rounded dense" style="bg-grey-3 text-black q-mb-md">
                    <label text="To enable all the features upgrade organization '${activeOrg.organizationName}' to Premium" type="b"/>
                    <container type="template v-slot:action">
                        <form-single name="UpgradeForm" transition="upgradeParty">
                            <field name="upgrade">
                                <default-field>
                                    <submit text="Upgrade" type="success" confirmation="Activating will cost 1 Organization-Month Credit per month while ${activeOrg.organizationName} is upgraded. Are you sure?"/>
                                </default-field>
                            </field>
                        </form-single>
                    </container>
                </container>
            </widgets>
        </section>

        <container>
            <container-row style="q-mt-md">
                <row-col sm="8" xs="6">
                    <label text="Product Evaluation on ${productEvaluation?.productName}" style="text-h4"/>
                    <label text="(#${productEvaluation?.productEvaluationId})" style="text-subtitle2 text-grey-8"/>
                    <container style="q-mb-md">
                        <label text="In the Requirements Selection step, add the requirements you want the product to be evaluated against." style="text-subtitle2 text-grey-8" condition="isUserInternalOrgMember &amp;&amp; (statusId == 'PeRequirementsSelection')"/>
                        <label text="Send invitations to product vendor representatives with a request for information about the applicability of their product to your requirement statements and process story activities." style="text-subtitle2 text-grey-8" condition="isUserInternalOrgMember &amp;&amp; (statusId == 'PeInviteVendors')"/>
                        <label text="You are waiting for vendor evaluations. You can track their responses below." style="text-subtitle2 text-grey-8" condition="isUserInternalOrgMember &amp;&amp; (statusId == 'PeAwaitingVendorResponse')"/>
                        <label text="This Product Evaluation is awaiting your responses. Please review the statements and stories below." style="text-subtitle2 text-grey-8" condition="isUserVendor &amp;&amp; (statusId == 'PeAwaitingVendorResponse')"/>            
                    </container>
                </row-col>
                <row-col sm="4" xs="6" style="float-right">
                    <container>
                        <label text="Status" style="text-bold" />
                    </container>
                    <container style="text-subtitle1">
                        <section name="StatusInteralSection" condition="!isVendorView">
                            <widgets>
                                <label text="Requirements Selection" style="${(statusId == 'PeRequirementsSelection')?'text-primary':'text-grey-8'}" />
                                <label text=" / " />
                                
                                <label text="Vendor Invitations" style="${(statusId == 'PeInviteVendors')?'text-primary':'text-grey-8'}" />
                                <label text=" / " />
                                
                                <label text="Awaiting Responses" style="${(statusId == 'PeAwaitingVendorResponse')?'text-primary':'text-grey-8'}" />
                                <label text=" / " />
                            </widgets>
                            <fail-widgets>
                                <label text="Awaiting Response" style="${(statusId == 'PeAwaitingVendorResponse')?'text-primary':'text-grey-8'}" />
                                <label text=" / " />
                            </fail-widgets>
                        </section>

                        <label text="Complete" style="${(statusId == 'PeCompleted')?'text-primary':'text-grey-8'}" condition="statusId != 'PeCancelled'"/>                        
                        <label text="Cancelled" style="text-negative text-bold" condition="(statusId == 'PeCancelled')"/>
                    </container>
                </row-col>
            </container-row>
        </container>


        <section name="EvalActionsSection" condition="!isVendorView">
            <widgets>
                <link url="finalizeActivitySelection" text="Finalize Requirements Selection" confirmation="Are you sure you want to finalize the requirements selection?" btn-type="success" tooltip="Finalize Requirements Selection" parameter-map="[productEvaluationId:productEvaluationId]" condition="statusId=='PeRequirementsSelection'" />
                <link url="reopenActivitySelection" text="Modify Requirements" parameter-map="[productEvaluationId:productEvaluationId]" condition="statusId=='PeInviteVendors'"/>
                
                <link url="finalizeVendorInvitations" text="Finalize Invitations" confirmation="Are you sure you want to finalize the vendor invitations?" btn-type="success" tooltip="Finalize Vendor Invitations" parameter-map="[productEvaluationId:productEvaluationId]" condition="statusId=='PeInviteVendors'"/>
                
                <link url="cancelProductEvaluation" text="Cancel Evaluation" confirmation="Are you sure you want to cancel this product evaluation?" btn-type="danger" tooltip="Cancel Product Evaluation" parameter-map="[productEvaluationId:productEvaluationId]" condition="['PeRequirementsSelection','PeInviteVendors'].contains(statusId)"/>
            
                <section name="CompleteSection" condition="['PeAwaitingVendorResponse'].contains(statusId)">
                    <widgets>
                        <link url="completeProductEvaluation" text="Complete Evaluation" confirmation="Are you sure you want to complete this product evaluation?" btn-type="success" tooltip="Complete Product Evaluation" parameter-map="[productEvaluationId:productEvaluationId]" condition="!hasWarnings"/>
        
                        <container-dialog id="CompleteEvaluationDialog" button-text="Complete Warnings" condition="hasWarnings" type="success">
                            <label text="Not all Statements have internal evaluations" style="q-mx-sm text-danger" type="p" condition="!internalRespondedToAllStatements"/>
                            <label text="Not all Statements have vendor evaluations"  style="q-mx-sm text-danger" type="p" condition="!vendorRespondedToAllStatements"/>
                            <label text="Not all Process Stories have internal evaluations" style="q-mx-sm text-danger" type="p" condition="!internalRespondedToAllStories"/>
                            <label text="Not all Process Stories have vendor evaluations" style="q-mx-sm text-danger" type="p" condition="!vendorRespondedToAllStories" />
                            <link url="completeProductEvaluation" text="Complete Evaluation Anyway" link-type="hidden-form"/>
                        </container-dialog>
                    </widgets>
                </section>
            </widgets>                
        </section>
            
        <section name="FullWidth" condition="statusId=='PeRequirementsSelection'">
            <widgets>
                <container-row>
                    <row-col sm="12">
                        <subscreens-panel id="ProductEvalPanel" type="tab" />
                    </row-col>
                </container-row>
            </widgets>
            <fail-widgets>
                <container-row >
                    <row-col sm="8">
                        <subscreens-panel id="ProductEvalPanel" type="tab" />
                    </row-col>
                    <row-col sm="4">
                        <section name="ProductVendorInviteListSection" condition="showInviteVendorsSection">
                            <widgets>
                                <container-box>
                                    <box-header>
                                        <container-dialog id="ProductVendorInviteDialog" button-text="${(statusId=='PeAwaitingVendorResponse'?'Invite':'Add')}" button-style="float-right" condition="canInviteVendors">
                                            <container>
                                                <label text="Send invitations to product vendor representatives with a request for information about the applicability of their product to your requirement statements and process story activities." condition="!isVendorView"/>                                                   
                                                <label text="Invite your team members by adding their email address below." condition="isVendorView"/>                                                
                                            </container>
                                            <form-single name="ProductVendorInviteForm" transition="inviteVendor">
                                                <field name="productEvaluationId">
                                                    <default-field>
                                                        <hidden />
                                                    </default-field>
                                                </field>
                                                <field name="emailAddress">
                                                    <default-field>
                                                        <text-line input-type="email"/>
                                                    </default-field>
                                                </field>
                                                <field name="submit">
                                                    <default-field>
                                                        <submit text="Invite"/>
                                                    </default-field>
                                                </field>
                                                <field-layout>
                                                    <field-col-row>
                                                        <field-col sm="9">
                                                            <field-ref name="emailAddress" />
                                                        </field-col>
                                                        <field-col sm="3">
                                                            <field-ref name="submit" />
                                                        </field-col>
                                                    </field-col-row>
                                                </field-layout>
                                            </form-single>
                                        </container-dialog>
                                        <label text="Vendor Representatives" style="text-bold q-mx-md"/>
                                    </box-header>
                                    <box-body>
                                        <label text="Add as many vendor representatives you would like to evaluate the product, against these requirements. Invitations will only be sent when you click 'Finalize Invitations'." style="text-caption text-grey-8" condition="!isVendorView &amp;&amp; ['PeRequirementsSelection','PeInviteVendors'].contains(statusId)"/>
                                        <label text="You have invited the following vendors representatives to evaluate this product. You can either invite more representatives to collaborate, or let the invited representatives add more of their team members." style="text-caption text-grey-8" condition="!isVendorView &amp;&amp; ['PeAwaitingVendorResponse'].contains(statusId)"/>

                                        <label text="The following users are part of this evaluation. You can add team members to assist you with this evaluation by clicking on the 'Invite' button." style="text-caption text-grey-8" condition="isVendorView &amp;&amp; ['PeAwaitingVendorResponse'].contains(statusId)"/> 
                                        
                                        <label text="The following users are part of this evaluation." style="text-caption text-grey-8" condition="isVendorView &amp;&amp; !['PeAwaitingVendorResponse'].contains(statusId)"/>   

                                        <section name="VendorListSection" condition="vendorRepList">
                                            <widgets>
                                                <form-list name="ProductVendorInviteList" list="vendorRepList">
                                                    <row-actions>
                                                        <entity-find-one entity-name="mantle.party.PersonAndUserAccount" value-field="personAndAccount">
                                                            <field-map field-name="partyId" />
                                                        </entity-find-one>
                                                    </row-actions>
                                                    <field name="partyId">
                                                        <default-field>
                                                            <hidden/>
                                                        </default-field>
                                                    </field>
                                                    <field name="combinedName">
                                                        <default-field title="Representative Name">
                                                            <display text="${personAndAccount?.firstName} ${personAndAccount?.lastName}" parameter-map="personAndAccount"/>
                                                        </default-field>
                                                    </field>
                                                    <field name="emailAddress">
                                                        <default-field>
                                                            <display text="${personAndAccount.emailAddress}"/>
                                                        </default-field>
                                                    </field>
                                                    <!-- simplified status -->
                                                    <field name="statusId">
                                                        <conditional-field condition="statusId=='PepPlanned'">
                                                            <display text="Pending" style="text-grey-8"/>
                                                        </conditional-field>
                                                        <conditional-field condition="['PepInvited','PepAccepted'].contains(statusId)">
                                                            <display text="Invited" style="text-grey-8"/>
                                                        </conditional-field>
                                                        <default-field title="Status">
                                                            <!-- <display-entity entity-name="moqui.basic.StatusItem"/> -->
                                                            <label text="N/A" />
                                                        </default-field>
                                                    </field>
                                                </form-list>
                                            </widgets>
                                        </section>
                                        <section name="NoVendorListSection" condition="!vendorRepList">
                                            <widgets>
                                                <container style="text-center">
                                                    <label text="Please add at least one vendor representative to evaluate this product." style="text-bold text-negative" />
                                                </container>
                                            </widgets>
                                        </section>
                                    </box-body>
                                </container-box>
                            </widgets>
                        </section>
                    </row-col>
                </container-row>
            </fail-widgets>
        </section>
    </widgets>
</screen>