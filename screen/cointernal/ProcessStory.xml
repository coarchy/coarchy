<?xml version="1.0" encoding="UTF-8"?>
<!--
This software is in the public domain under CC0 1.0 Universal plus a
Grant of Patent License.

To the extent possible under law, the author(s) have dedicated all
copyright and related and neighboring rights to this software to the
public domain worldwide. This software is distributed without any
warranty.

You should have received a copy of the CC0 Public Domain Dedication
along with this software (see the LICENSE.md file). If not, see
<http://creativecommons.org/publicdomain/zero/1.0/>.
-->
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="Process Story" default-menu-index="99" menu-image="/ssstatic/images/project-business120.png" default-menu-include="true" >

    <parameter name="processStoryId" from="processStoryId ?: null"/>

    <transition name="newParagraph"><service-call name="create#coarchy.ProcessStoryActivity" in-map="[processStoryId:processStoryId,activityId:newActivity.activityId, sequenceNum:processStoryActivityList?.getFirst()?.sequenceNum ? processStoryActivityList?.getFirst()?.sequenceNum + 1 : 0]"/>
        <default-response></default-response>
    </transition>

    <transition name="createActivity"><actions>
            <service-call name="create#coarchy.Activity" in-map="[condition:condition, action:action]" out-map="newActivity"/>

            <entity-find entity-name="coarchy.ProcessStoryActivity" limit="1" list="processStoryActivityList">
                <order-by field-name="-sequenceNum"/></entity-find>
            <service-call name="create#coarchy.ProcessStoryActivity" in-map="[processStoryId:processStoryId,activityId:newActivity.activityId, sequenceNum:processStoryActivityList?.getFirst()?.sequenceNum ? processStoryActivityList?.getFirst()?.sequenceNum + 1 : 0]"/>

<!--            <log level="warn" message="actorIdList ${actorIdList.getClass()}"/>-->
            <if condition="actorIdList instanceof String">
                <then>
<!--                    <log level="warn" message="status is null"/>-->
                    <service-call name="create#coarchy.ActivityActor" in-map="[activityId:newActivity.activityId, actorId:actorIdList]"/>
                </then>
                <else>
<!--                    <log level="warn" message="status is not null"/>-->
                    <iterate list="actorIdList" entry="actorId">
<!--                        <log level="warn" message="actorId ${actorId}"/>-->
                        <service-call name="create#coarchy.ActivityActor" in-map="[activityId:newActivity.activityId, actorId:actorId]"/>
                    </iterate>
                </else>
            </if>
            </actions><default-response url="."/></transition>

    <transition name="updateActivity"><service-call name="update#coarchy.Activity"/><actions>
        <entity-find entity-name="coarchy.ActivityActor" list="activityActorList">
            <econdition field-name="activityId"/></entity-find>
<!--        <if condition="activityActorList">-->
<!--            <set field="actorIdDeleteList" from="activityActorList*.actorId - actorIdList?:[]"/>-->
<!--            &lt;!&ndash;        <log level="warn" message="actorIdDeleteList ${actorIdDeleteList}"/>&ndash;&gt;-->
<!--            <iterate list="actorIdDeleteList" entry="actorIdDelete">-->
<!--                <set field="activityActorIdDelete" from="activityActorList.find{it.actorId == actorIdDelete}?.activityActorId"/>-->
<!--                &lt;!&ndash;            <log level="warn" message="activityActorIdDelete ${activityActorIdDelete}"/>&ndash;&gt;-->
<!--                <service-call name="delete#coarchy.ActivityActor" in-map="[activityActorId:activityActorIdDelete]"/>-->
<!--            </iterate>-->
<!--        </if>-->

        <if condition="actorIdList instanceof String">
            <then>
                <service-call name="store#coarchy.ActivityActor" in-map="[activityId:activityId, actorId:actorIdList]"/></then>
            <else>
                <iterate list="actorIdList" entry="actorId">
                    <service-call name="store#coarchy.ActivityActor" in-map="[activityId:activityId, actorId:actorId]"/>
                </iterate>
            </else>
        </if>

        </actions><default-response url="."/></transition>

    <transition name="getActorList">
        <actions>
            <set field="actorList" from="[]"/>
            <if condition="term == null &amp;&amp; actorIdList ? actorIdList?.size() &gt; 0 : false"><then>
                <entity-find entity-name="coarchy.Actor" list="actorList" limit="20">
                    <econdition field-name="actorId" operator="in" from="actorIdList"/>
                    <order-by field-name="name"/></entity-find>
            </then><else>
                <entity-find entity-name="coarchy.Actor" list="actorList" limit="20">
                    <econdition field-name="name" operator="like" value="%${term}%" ignore-case="true"/>
                    <order-by field-name="name"/></entity-find>
            </else></if>
            <script>
                def outList = []
                for (def actor in actorList)
                    outList.add([value:actor?.actorId, label:"${actor?.name}".toString()])
                ec.web.sendJsonResponse(outList)
            </script>
        </actions>
        <default-response type="none"/>
    </transition>
    <actions>
        <!-- MVP Phase One: Only allow one processStory per User -->
        <if condition="processStoryId == null">
            <entity-find entity-name="coarchy.ProcessStory" list="processStoryList" limit="1">
                <order-by field-name="-lastUpdatedStamp"/></entity-find>
            <if condition="processStoryList?.getFirst()?.processStoryId == null">
                <then><service-call name="create#coarchy.ProcessStory" out-map="newProcessStory"/><set field="processStoryId" from="newProcessStory.processStoryId"/></then>
                <else><set field="processStoryId" from="processStoryList.getFirst().processStoryId"/></else>
            </if>
        </if>

<!--        <log level="warn" message="processStoryActivityList ${processStoryActivityList}"/>-->
    </actions>

    <widgets>
        <!-- TODO: get rid of this next line and replace it with the format from https://github.com/jonesde/moqui-quasar-custom -->
        <text><![CDATA[<q-page-container class="q-ma-sm"><q-page>]]></text>
        <link url="../Actor" text="Actor"/>

        <form-list name="ProcessStory" paginate="false" skip-header="true" list="processStoryActivityList"
                transition="updateActivity" transition-last-row="createActivity">
            <entity-find entity-name="coarchy.ProcessStoryActivityDetail" list="processStoryActivityList">
                <order-by field-name="sequenceNum"/></entity-find>

            <row-actions>
                <entity-find entity-name="coarchy.ActivityActorDetail" list="activityActorList">
                    <econdition field-name="activityId"/>
                    <order-by field-name="name"/></entity-find>
                <set field="actorIdList" from="activityActorList*.actorId"/>
<!--                <log level="warn" message="actorIdList ${actorIdList}"/>-->
            </row-actions>
            <field name="activityId"><default-field><hidden/></default-field></field>

            <field name="condition"><default-field><text-area rows="2" cols="60"/></default-field>
                <last-row-field><text-area rows="2" cols="60"/></last-row-field></field>
            <!-- TODO: Autofill in previous parameters in a dropdown with dynamic options and server search -->
            <!-- TODO: Add submit-on-select to make it easier to select. Right now a bug that doesn't show the transitions text when that is toggled on -->
            <field name="actorIdList">
                <default-field title="Actor"><drop-down allow-empty="true" allow-multiple="true">
                    <list-options list="activityActorList" key="${actorId}" text="${name}"/>
                    <dynamic-options server-search="true" transition="getActorList" min-length="0"/>
                </drop-down></default-field>
                <last-row-field title="Actor"><drop-down allow-empty="true" allow-multiple="true">
                    <dynamic-options server-search="true" transition="getActorList" min-length="0"/>
                </drop-down></last-row-field>
            </field>
            <field name="action"><default-field><text-area rows="2" cols="80"/></default-field>
                <last-row-field><text-area rows="2" cols="80"/></last-row-field></field>
            <field name="submit"><default-field><submit text="Update"/></default-field>
                <last-row-field><submit text="Create"/></last-row-field></field>



            <columns>
                <column><field-ref name="condition"/></column>
                <column><field-ref name="actorIdList"/></column>
                <column><field-ref name="action"/></column>
                <column><field-ref name="submit"/></column>
            </columns>
        </form-list>
        <form-single name="CreateActivity" transition="createActivity">
            <field name="condition"><default-field><text-area rows="3"/></default-field></field>
            <field name="actorIdList"><default-field><drop-down allow-empty="true" allow-multiple="true">
                <!-- TODO: Allow creating an actor in the find field with a modified DropDown vue component -->
                <dynamic-options server-search="true" transition="getActorList"/>
            </drop-down></default-field></field>
            <field name="action"><default-field><text-area rows="3"/></default-field></field>
            <field name="submit"><default-field><submit text="Create"/></default-field></field>
            <field name="newParagraph"><default-field><link url="" url-type="transition"/></default-field></field>

            <field-layout>
                <field-row-big><field-ref name="condition"/><field-ref name="actorIdList"/><field-ref name="action"/><field-ref name="submit"/></field-row-big>
            </field-layout>
        </form-single>
        <text><![CDATA[</q-page></q-page-container>]]></text>
    </widgets>
</screen>
