<?xml version="1.0" encoding="UTF-8"?>
<!--
This software is in the public domain under CC0 1.0 Universal plus a
Grant of Patent License.

To the extent possible under law, the author(s) have dedicated all
copyright and related and neighboring rights to this software to the
public domain worldwide. This software is distributed without any
warranty.

You should have received a copy of the CC0 Public Domain Dedication
along with this software (see the LICENSE.md file). If not, see
<http://creativecommons.org/publicdomain/zero/1.0/>.
-->
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="Process Story" default-menu-index="92" menu-image="fa fa-file" menu-image-type="icon">

    <parameter name="processStoryId" required="true"/>

    <always-actions>
        <if condition="!activeOrgId">
            <message>Select an Organization before moving forward.</message>
            <script>sri.sendRedirectAndStopRender('/settings/Organizations')</script>
        </if>
        <entity-find-count entity-name="mantle.party.PartyRelationship" count-field="partyRelationshipCount">
            <date-filter/>
            <econdition field-name="relationshipTypeEnumId" value="PrtMember"/>
            <econdition field-name="toRoleTypeId" value="OrgInternal"/>
            <econdition field-name="fromPartyId" from="ec.user.userAccount.partyId"/>
            <econdition field-name="toPartyId" from="activeOrgId"/></entity-find-count>
    </always-actions>

    <transition name="newParagraph"><condition><expression>partyRelationshipCount &gt; 0</expression></condition><actions>
        <service-call name="create#coarchy.Activity" in-map="[organizationId:activeOrgId]" out-map="newActivity"/>

        <entity-find entity-name="coarchy.ProcessStoryActivity" limit="1" list="processStoryActivityList">
            <order-by field-name="-sequenceNum"/></entity-find>
        <set field="highestProcessStoryActivity" from="processStoryActivityList?.getFirst()"/>
        <set field="newSequenceNum" from="highestProcessStoryActivity?.sequenceNum != null ? highestProcessStoryActivity?.sequenceNum + 1 : 0"/>
        <service-call name="create#coarchy.ProcessStoryActivity" in-map="[processStoryId:processStoryId,activityId:newActivity.activityId, sequenceNum:newSequenceNum, organizationId:activeOrgId]"/>
        </actions><default-response url="."/></transition>

    <transition name="createActivity"><condition><expression>partyRelationshipCount &gt; 0</expression></condition><actions>
        <!-- TODO: migrate this to a service -->
        <if condition="!action"><return type="warning" message="An action is needed for an activity"/></if>
        <service-call name="create#coarchy.Activity" in-map="[condition:condition, action:action, organizationId:activeOrgId]" out-map="newActivity"/>

        <entity-find entity-name="coarchy.ProcessStoryActivity" limit="1" list="processStoryActivityList">
            <order-by field-name="-sequenceNum"/></entity-find>
        <set field="highestProcessStoryActivity" from="processStoryActivityList?.getFirst()"/>
        <set field="newSequenceNum" from="highestProcessStoryActivity?.sequenceNum != null ? highestProcessStoryActivity?.sequenceNum + 1 : 0"/>
        <service-call name="create#coarchy.ProcessStoryActivity" in-map="[processStoryId:processStoryId,activityId:newActivity.activityId, sequenceNum:newSequenceNum, organizationId:activeOrgId]"/>

        <if condition="actorIdList?.size() != 0 &amp;&amp; actorIdList instanceof String">
            <then>
                <service-call name="create#coarchy.ActivityActor" in-map="[activityId:newActivity.activityId, actorId:actorIdList, organizationId:activeOrgId]"/>
            </then>
            <else>
                <iterate list="actorIdList" entry="actorId">
                    <service-call name="create#coarchy.ActivityActor" in-map="[activityId:newActivity.activityId, actorId:actorId, organizationId:activeOrgId]"/>
                </iterate>
            </else>
        </if>
        </actions><default-response url="."/></transition>

<!--    <transition name="updateActivity2"><actions>-->
<!--        <service-call name="coarchy.CoarchyServices.update#Activity" in-map="[activityId:activityId,condition:condition,actorIdList:actorIdList,action:action,organizationId:activeOrgId]" multi="true"/>-->
<!--    </actions>-->
<!--        <default-response url="."/></transition>-->

    <transition name="updateActivity2"><actions>
        <log level="warn" message="context.toString() ${context.toString()}"/>
        <service-call name="coarchy.CoarchyServices.update#Activity" in-map="[activityId:activityId,condition:condition,actorIdList:actorIdList,action:action,organizationId:activeOrgId]" multi="true"/>
    </actions><default-response url="."/></transition>

    <transition name="activityMoveUp"><condition><expression>partyRelationshipCount &gt; 0</expression></condition><actions>
        <entity-find entity-name="coarchy.ProcessStoryActivityDetail" list="processStoryActivityList" limit="1">
            <econdition field-name="sequenceNum" operator="less" from="sequenceNum.toInteger()"/>
            <select-field field-name="processStoryActivityId,sequenceNum"/>
            <order-by field-name="-sequenceNum"/></entity-find>

        <set field="processStoryActivity" from="processStoryActivityList?.getFirst()"/>
        <if condition="processStoryActivity?.sequenceNum != null">
            <then>
                <service-call name="update#coarchy.ProcessStoryActivity" in-map="[processStoryActivityId:processStoryActivity.processStoryActivityId,sequenceNum:sequenceNum]"/>
                <service-call name="update#coarchy.ProcessStoryActivity" in-map="[processStoryActivityId:processStoryActivityId,sequenceNum:processStoryActivity.sequenceNum]"/>
            </then><else>
                <return type="warning" message="Cannot move activity up"/>
            </else>
        </if>
        </actions><default-response url="."/></transition>

    <transition name="activityMoveDown"><condition><expression>partyRelationshipCount &gt; 0</expression></condition><actions>
        <entity-find entity-name="coarchy.ProcessStoryActivityDetail" list="processStoryActivityList" limit="1">
            <econdition field-name="sequenceNum" operator="greater" from="sequenceNum.toInteger()"/>
            <select-field field-name="processStoryActivityId,sequenceNum"/>
            <order-by field-name="sequenceNum"/></entity-find>

        <set field="processStoryActivity" from="processStoryActivityList?.getFirst()"/>
        <if condition="processStoryActivity?.sequenceNum != null">
            <then>
                <service-call name="update#coarchy.ProcessStoryActivity" in-map="[processStoryActivityId:processStoryActivity.processStoryActivityId,sequenceNum:sequenceNum]"/>
                <service-call name="update#coarchy.ProcessStoryActivity" in-map="[processStoryActivityId:processStoryActivityId,sequenceNum:processStoryActivity.sequenceNum]"/>
            </then><else>
            <return type="warning" message="Cannot move activity down"/>
        </else>
        </if>
        </actions><default-response url="."/></transition>

    <transition name="deleteActivity"><condition><expression>partyRelationshipCount &gt; 0</expression></condition><actions>
        <if condition="actorIdList?.size() != 0 &amp;&amp; actorIdList instanceof String">
            <then>
                <service-call name="delete#coarchy.ActivityActor" in-map="[activityId:activityId, actorId:actorIdList]"/>
            </then>
            <else>
                <iterate list="actorIdList" entry="actorId">
                    <service-call name="delete#coarchy.ActivityActor" in-map="[activityId:activityId, actorId:actorId]"/>
                </iterate>
            </else>
        </if>
        <service-call name="delete#coarchy.ProcessStoryActivity" in-map="[processStoryActivityId:processStoryActivityId]"/>
        </actions><default-response url="."/></transition>

    <transition name="getActorList"><condition><expression>partyRelationshipCount &gt; 0</expression></condition><actions>
            <set field="actorList" from="[]"/>
            <if condition="term == null &amp;&amp; actorIdList ? actorIdList?.size() &gt; 0 : false"><then>
                <entity-find entity-name="coarchy.Actor" list="actorList" limit="20">
                    <econdition field-name="actorId" operator="in" from="actorIdList"/>
                    <order-by field-name="name"/></entity-find>
            </then><else>
                <entity-find entity-name="coarchy.Actor" list="actorList" limit="20">
                    <econdition field-name="name" operator="like" value="%${term}%" ignore-case="true"/>
                    <order-by field-name="name"/></entity-find>
            </else></if>
            <script>
                def outList = []
                for (def actor in actorList)
                    outList.add([value:actor?.actorId, label:"${actor?.name}".toString()])
                ec.web.sendJsonResponse(outList)
            </script>
        </actions>
        <default-response type="none"/>
    </transition>

    <transition name="updateProcessStory"><condition><expression>partyRelationshipCount &gt; 0</expression></condition><service-call name="update#coarchy.ProcessStory"/>
        <default-response/></transition>

    <transition-include name="createActor" location="component://coarchy/screen/coarchy/cointernal/Actor.xml"/>

    <actions>
        <!-- MVP Phase One: Only allow one processStory per User -->
        <if condition="actorIdList">
            <entity-find entity-name="coarchy.Actor" list="headerActorList">
                <econdition field-name="actorId" operator="in" from="actorIdList"/>
                <order-by field-name="name"/></entity-find>
        </if>
        <entity-find-count entity-name="coarchy.ProcessStoryActivity" count-field="activityCount">
            <econdition field-name="processStoryId"/></entity-find-count>

        <entity-find-one entity-name="coarchy.ProcessStory" value-field="processStory" auto-field-map="[processStoryId:processStoryId]"/>
        <!-- Currently this only supports one parent process story -->
        <entity-find entity-name="coarchy.ProcessStoryActivity" list="detailActivityList" limit="1">
            <econdition field-name="detailProcessStoryId" from="processStoryId"/>
            <order-by field-name="-lastUpdatedStamp"/></entity-find>

        <set field="showMoveUpDown" from="!actorIdList &amp;&amp; !condition &amp;&amp; !action"/>
<!--        <log level="warn" message="context.toString() ${context.toString()}"/>-->
    </actions>

    <widgets>
        <link url="../ProcessStory" parameter-map="[processStoryId:detailActivityList?.getFirst()?.processStoryId]" text="Go to Parent Story: ${detailActivityList?.getFirst()?.story?.name}" condition="detailActivityList?.getFirst()?.processStoryId"/>
        <link url="../FindProcessStory" text="Find Process Stories"/>
        <link url="../Actor" parameter-map="[processStoryId:processStoryId]" text="Go to Actors"/>
        <label text="Process Story - ${processStory.name}" type="h2"/>
        <form-single name="UpdateProcessStory" transition="updateProcessStory">
            <field name="processStoryId"><default-field><hidden/></default-field></field>
            <field name="name" from="processStory.name"><default-field title="Process Story Name"><text-line/></default-field></field>
            <field name="submit"><default-field><submit text="Update"/></default-field></field>
            <field-layout><field-row><field-ref name="name"/><field-ref name="submit"/></field-row></field-layout>
        </form-single>

        <container-dialog id="AddActorDialogue" button-text="Add Actor">
            <form-single name="AddActor" transition="createActor">
                <field name="processStoryId"><default-field><hidden/></default-field></field>
                <field name="name"><default-field><text-line/></default-field></field>
                <field name="description"><default-field><text-area rows="2" cols="80"/></default-field></field>
                <field name="submit"><default-field><submit text="Create"/></default-field></field>
            </form-single></container-dialog>
        <link url="../ViewProcessStory" text="View Pretty" tooltip="Go to View Process Story" parameter-map="[processStoryId:processStoryId]" condition="activityCount &gt; 0"/>
        <form-list name="ProcessStory" paginate="false" header-dialog="true" list="processStoryActivityList" show-csv-button="true"
                transition="updateActivity2" transition-last-row="createActivity" map-last-row="[actorIdList:null,condition:null,action:null]" multi="true">
            <entity-find entity-name="coarchy.ProcessStoryActivityDetail" list="processStoryActivityList" distinct="true">
                <search-form-inputs default-order-by="sequenceNum"/>
                <econdition field-name="processStoryId"/>
                <econdition field-name="actorId" operator="in" from="actorIdList" ignore-if-empty="true"/>
                <!-- Don't select fields from activityactor (actorId) -->
                <select-field field-name="processStoryActivityId,sequenceNum,detailProcessStoryId"/>
            </entity-find>

            <row-actions>
                <set field="activityActorList" from="[]"/>
                <entity-find entity-name="coarchy.ActivityActorDetail" list="activityActorList">
                    <econdition field-name="activityId"/>
                    <order-by field-name="name"/></entity-find>
                <set field="actorIdList" from="activityActorList*.actorId"/>
            </row-actions>
            <field name="activityId"><default-field><hidden/></default-field></field>

            <!-- TODO: Make reordering drag and drop instead of arrows -->
            <field name="moveUp"><conditional-field condition="showMoveUpDown" title=""><link url="activityMoveUp" parameter-map="[processStoryActivityId:processStoryActivityId,sequenceNum:sequenceNum]" condition="processStoryActivityList_index != 0" icon="fa fa-angle-up" text=" "/></conditional-field></field>
            <field name="moveDown"><conditional-field condition="showMoveUpDown" title=""><link url="activityMoveDown" parameter-map="[processStoryActivityId:processStoryActivityId,sequenceNum:sequenceNum]" condition="processStoryActivityList_has_next" icon="fa fa-angle-down" text=" "/></conditional-field></field>
            <!-- TODO: Fix allowing < and > tags in to prevent attacks -->
            <field name="condition"><header-field title="Condition" show-order-by="case-insensitive"><text-find size="25" default-operator="begins"/></header-field>
                <conditional-field condition="action" title="Condition"><text-area rows="2"/></conditional-field>
                <last-row-field><text-area rows="2"/></last-row-field></field>
            <field name="actorIdList">
                <header-field title="Actor"><drop-down allow-empty="true" allow-multiple="true">
                    <list-options list="headerActorList" key="${actorId}" text="${name}"/>
                    <dynamic-options server-search="true" transition="getActorList" min-length="0"/>
                </drop-down></header-field>
                <conditional-field condition="action" title="Actor"><drop-down allow-empty="true" allow-multiple="true">
                    <list-options list="activityActorList" key="${actorId}" text="${name}"/>
                    <dynamic-options server-search="true" transition="getActorList" min-length="0"/>
                </drop-down></conditional-field>
                <last-row-field title="Actor"><drop-down allow-empty="true" allow-multiple="true">
                    <dynamic-options server-search="true" transition="getActorList" min-length="0"/>
                </drop-down></last-row-field>
            </field>
            <field name="action"><header-field title="Action" show-order-by="case-insensitive"><text-find size="25" default-operator="begins"/></header-field>
                <conditional-field condition="action" title="Action"><text-area rows="2" cols="80"/></conditional-field>
                <last-row-field><text-area rows="2" cols="80"/></last-row-field></field>
            <field name="substory"><conditional-field condition="!detailProcessStoryId &amp;&amp; action &amp;&amp; !detailActivityList?.getFirst()?.processStoryId &amp;&amp; partyRelationshipCount &gt; 0" title=""><dynamic-dialog id="SubstoryDialogue" transition="CreateOrSelectSubstory" button-text="Substory" parameter-map="[processStoryActivityId:processStoryActivityId,parentProcessStoryIdList:detailActivityList*.processStoryId]"/></conditional-field></field>
            <field name="substoryLink"><conditional-field condition="detailProcessStoryId &amp;&amp; action" title=""><link url="../ProcessStory" parameter-map="[processStoryId:detailProcessStoryId]" text="Substory"/></conditional-field></field>
            <field name="delete"><default-field title=""><link url="deleteActivity" parameter-map="[processStoryActivityId:processStoryActivityId,activityId:activityId,actorIdList:actorIdList]" icon="fa fa-trash" btn-type="danger" text="" tooltip="Delete Activity"/></default-field></field>
            <field name="submit"><header-field title="Find"><submit/></header-field>
                <default-field title=""><submit text="Update All"/></default-field>
                <last-row-field><submit text="Create"/></last-row-field></field>
            <field name="newParagraph"><conditional-field condition="false" title=""><label text=" "/></conditional-field>
                <last-row-field><link url="newParagraph" text="⏎" tooltip="New Paragraph"/></last-row-field></field>

            <form-list-column><field-ref name="condition"/></form-list-column>
            <form-list-column><field-ref name="actorIdList"/></form-list-column>
            <form-list-column><field-ref name="action"/></form-list-column>
            <form-list-column><field-ref name="submit"/></form-list-column>

            <columns>
                <column><field-ref name="moveUp"/><field-ref name="moveDown"/></column>
                <column><field-ref name="condition"/></column>
                <column><field-ref name="actorIdList"/></column>
                <column><field-ref name="action"/></column>
                <column><field-ref name="submit"/><field-ref name="substory"/><field-ref name="substoryLink"/></column>
                <column><field-ref name="newParagraph"/><field-ref name="delete"/></column>
            </columns>

        </form-list>
    </widgets>
</screen>
