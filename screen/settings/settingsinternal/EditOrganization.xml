<?xml version="1.0" encoding="UTF-8"?>
<!--
This software is in the public domain under CC0 1.0 Universal plus a
Grant of Patent License.

To the extent possible under law, the author(s) have dedicated all
copyright and related and neighboring rights to this software to the
public domain worldwide. This software is distributed without any
warranty.

You should have received a copy of the CC0 Public Domain Dedication
along with this software (see the LICENSE.md file). If not, see
<http://creativecommons.org/publicdomain/zero/1.0/>.
-->
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="Edit Organization" default-menu-index="81" menu-image="/ssstatic/images/Parties.png" default-menu-include="false">

    <parameter name="organizationId" required="true"/>

    <transition name="removeUser"><actions>
        <entity-find-one entity-name="mantle.party.Party" value-field="organization" auto-field-map="[partyId:organizationId]"/>
        <if condition="fromPartyId == ec.user.userAccount.partyId || organization.ownerPartyId != ec.user.userAccount.partyId"><return message="Cannot remove user" type="warning"/></if>

        <entity-find entity-name="mantle.party.PartyRelationship" list="partyRelationshipList">
            <econdition field-name="toPartyId"/>
            <econdition field-name="fromPartyId"/>
            <econdition field-name="toRoleTypeId" value="OrgInternal"/>
            <select-field field-name="partyRelationshipId"/>
        </entity-find>

        <iterate list="partyRelationshipList" entry="partyRelationship">
            <service-call name="delete#mantle.party.PartyRelationship" in-map="[partyRelationshipId:partyRelationship.partyRelationshipId]"/>
        </iterate>
    </actions><default-response/></transition>

    <transition name="updateOrganization"><actions>
        <entity-find-one entity-name="mantle.party.Party" value-field="organization" auto-field-map="[partyId:partyId]"/>
        <if condition="!organization || !organization.ownerPartyId"><return type="warning" message="You can't change an organization you don't own"/></if>
        <if condition="organization.ownerPartyId == ec.user.userAccount.partyId">
            <service-call name="update#mantle.party.Organization" in-map="[partyId:partyId,organizationName:organizationName]"/>
        </if>
    </actions><default-response url="." parameter-map="[organizationId:partyId]"/></transition>

    <transition-include name="inviteUser" location="component://coarchy/screen/settings/settingsinternal/Organizations.xml"/>
    <transition-include name="goToApplication" location="component://coarchy/screen/settings/settingsinternal/Organizations.xml"/>
    <transition-include name="createOrganization" location="component://coarchy/screen/settings/settingsinternal/Organizations.xml"/>

    <actions>
        <entity-find-one entity-name="mantle.party.PartyDetail" value-field="organization" auto-field-map="[partyId:organizationId]"/>

        <log level="warn" message="context.toString() ${context.toString()}"/>
    </actions>

    <widgets>
        <label text="Edit ${organization?.organizationName?:' Organization'}" type="h4"/>

        <link url="goToApplication" text="View ${organization?.organizationName?:' Organization'}" parameter-map="[partyId:organizationId]" tooltip="Create Process Stories"/>
        <link url="../Organizations" text="Find Organizations"/>

        <container-dialog id="InviteUser" type="success" button-text="Invite User">
            <form-single name="InviteUser" transition="inviteUser">
                <field name="partyId" from="organizationId"><default-field><hidden/></default-field></field>
                <field name="emailAddress"><default-field><text-line/></default-field></field>
                <field name="firstName"><default-field><text-line/></default-field></field>
                <field name="lastName"><default-field><text-line/></default-field></field>
                <field name="submit"><default-field><submit/></default-field></field>
            </form-single>
        </container-dialog>

        <container-dialog id="CloneFrom" button-text="Clone From">
            <label text="This will create a New Organization from a copy of ${organization.organizationName}" type="h6"/>
            <form-single name="CloneFromOrganization" transition="createOrganization">
            <field name="organizationId" from="partyId"><default-field><hidden/></default-field></field>
            <field name="organizationName" from="null"><default-field title="New Organization Name"><text-line/></default-field></field>
            <field name="clone"><default-field><submit/></default-field></field>
        </form-single></container-dialog>

        <container-dialog id="UpdateOrganizationDialog" button-text="Edit Organization Name">
            <form-single name="UpdateOrganization" transition="updateOrganization">
                <field name="partyId" from="organizationId"><default-field><hidden/></default-field></field>
                <field name="organizationName" from="organization.organizationName"><default-field title="Organization Name"><text-line size="50"/></default-field></field>
                <field name="submit"><default-field><submit text="Update"/></default-field></field>
            </form-single>
        </container-dialog>

        <form-list name="Users" list="usersList" header-dialog="true" show-page-size="true" show-csv-button="true">
            <entity-find entity-name="mantle.party.PartyFromAndRelationship" list="usersList" distinct="true">
                <search-form-inputs default-order-by="-lastUpdatedStamp"/>
                <econdition field-name="toPartyId" from="organizationId"/>
                <select-field field-name="firstName,lastName"/>
                </entity-find>

            <row-actions>
                <!-- This assumes there are only one UserAccount per party in the application -->
                <if condition="fromPartyId == ec.user.userAccount.partyId || (fromPartyId != ec.user.userAccount.partyId &amp;&amp; organization.ownerPartyId == ec.user.userAccount.partyId)">
                    <entity-find entity-name="moqui.security.UserAccount" list="userAccountList">
                        <econdition field-name="partyId" from="fromPartyId"/>
                        <select-field field-name="emailAddress"/>
                        <order-by field-name="-lastUpdatedStamp"/></entity-find>
                    <set field="userAccount" from="userAccountList?.getFirst()"/>
                </if>
            </row-actions>
            <hidden-parameters><parameter name="organizationId"/></hidden-parameters>
            <field name="firstName"><header-field show-order-by="case-insensitive"><text-find size="25"/></header-field></field>
            <field name="lastName"><header-field show-order-by="case-insensitive"><text-find size="25"/></header-field></field>

            <field name="fromPartyId"><default-field><hidden/></default-field></field>
            <field name="name"><default-field><label text="${firstName} ${lastName}"/></default-field></field>
            <field name="emailAddress" from="userAccount?.emailAddress ?: 'Not Authorized'">
                <default-field><display/></default-field></field>
            <field name="remove"><conditional-field condition="fromPartyId != ec.user.userAccount.partyId &amp;&amp; organization.ownerPartyId == ec.user.userAccount.partyId" title=""><link url="removeUser" parameter-map="[fromPartyId:fromPartyId,toPartyId:organizationId]" icon="fa fa-trash" btn-type="danger" text=" " tooltip="Remove ${firstName} ${lastName} from ${organization?.organizationName?:' Organization'}"/></conditional-field></field>
            <field name="search"><header-field><submit/></header-field></field>
        </form-list>
    </widgets>
</screen>
